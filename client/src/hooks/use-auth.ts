import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import type { User } from "@shared/models/auth";

async function fetchUser(): Promise<User | null> {
  const response = await fetch("/api/me", { credentials: "include" });
  if (response.status === 401) return null;
  if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
  const data = await response.json();
  return data.user;
}

async function logout(): Promise<void> {
  await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
  window.location.href = "/";
}

export function useAuth() {
  const queryClient = useQueryClient();
  const { data: user, isLoading } = useQuery<User | null>({ queryKey: ["/api/me"], queryFn: fetchUser, retry: false, staleTime: 1000 * 60 * 5 });
  const logoutMutation = useMutation({ mutationFn: logout, onSuccess: () => queryClient.setQueryData(["/api/me"], null) });
  return { user, isLoading, isAuthenticated: !!user, logout: logoutMutation.mutate, isLoggingOut: logoutMutation.isPending };
}
